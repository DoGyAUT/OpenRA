# Travis-CI Build for OpenRA
# see travis-ci.org for details

language: csharp
mono: 4.6.1

# http://docs.travis-ci.com/user/migrating-from-legacy
sudo: false

cache:
  directories:
  - thirdparty/download

addons:
  apt:
    packages:
    - lua5.1
    - nsis
    - nsis-common
    - dpkg
    - markdown

# Environment variables
env:

# Fetch dependencies
# Run the build script
# Check source code with StyleCop
# call OpenRA to check for YAML errors
# Run the NUnit tests
script:
 - travis_retry make all-dependencies
 - make all SDK="-sdk:4.5"
 - make check
 - make check-scripts
 - make test
 - make nunit

# Automatically update the trait documentation and Lua API
after_success:
 - test $TRAVIS_PULL_REQUEST == "false" && make docs && cd packaging && ./update-wiki.sh $TRAVIS_BRANCH; cd ..

# Only watch the development branch and tagged release.
branches:
 only:
   - /^cd-release-.*$/

# Notify developers when build passed/failed.
notifications:

before_deploy:
 - export PATH=$PATH:$HOME/usr/bin
 - DOTVERSION=`echo ${TRAVIS_TAG} | sed "s/-/\\./g"`
 - cd packaging
 - mkdir build
 - ./package-all.sh ${TRAVIS_TAG} ${PWD}/build/
deploy:
  provider: releases
  api_key:
    secure: "ULWEbq6QVecDlbw9r8kTNh5Lrh8/iuvKysJOnlz61E7oArVC51fUAL8GqADUWKTTPm3qEid/hUDSMabh6LACo02dTX2kNYxiHqYLxUGg6zWm9frkmil6HEMKsY4D4x2NV0SWm8VfNfcX7z8dccPWb5A+qHdMbIR1Y9P3OxtIMN7FFVeXxuAJeALlfMoHLbaP/HuOx4Aw3qpc5cnKAz8lSompG+OG1b9obkbmXmQqCCnxeC1G+KzDyFb8PClROaNkqsWUPZWBtOt/GmByGcm6kSHpHjOU+2PHDLqx3QWnKo5cHSq6LQWSXRpzY+8y1hcRoXyYuglRIWc+0rfVhdkxnB4vuIsRk7ep/Yi39YT5kEtA+iS4FtUN2ZguHwHmJASoVEfYuPffTHRgKIapFG0rY4/Dty3epO8Al9KXmmd0SJrOQKkIokXTOTCyPKWiZNPl+OupndeEvGt0M9R4qYaS2gid2T6C+Zft087RmqLwZaUYmWN9k3XtrNbSJGdeFJYigYOWfM2T74zSK0raYouy2Um/c6eWr+uIDHrCBu3vS3IeqR34U8b04XI7Ik2bntH1McYLoz5JFpuvDAeU7kj+vbicsSVMl9c0qG1fAETkGqrZJ6/u7ED0Xw1JJ9M6lG3kIEnxpcYVqVBfN3n6c39YtRPC6sXINho4qGP31s/j7Cs="
  file:
    - build/OpenRA-${TRAVIS_TAG}.exe
    - build/OpenRA-${TRAVIS_TAG}.zip
    - build/openra_${DOTVERSION}_all.deb
  skip_cleanup: true
  on:
    all_branches: true
    tags: true
    repo: jrb0001/OpenRA
